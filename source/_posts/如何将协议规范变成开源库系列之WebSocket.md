---
title: å¦‚ä½•å°†åè®®è§„èŒƒå˜æˆå¼€æºåº“ç³»åˆ—ä¹‹ WebSocket
categories:
- å®ç”¨ç±»åº“
tags:
- WebSocket
---

è¿™æ˜¯ç³»åˆ—æ–‡ç« çš„ç¬¬ä¸€ç¯‡ï¼Œä¹Ÿæ˜¯éå¸¸é‡è¦çš„ä¸€ç¯‡ï¼Œå¸Œæœ›å¤§å®¶èƒ½è¯»æ‡‚æˆ‘æƒ³è¦è¡¨è¾¾çš„æ„æ€ã€‚

## ç³»åˆ—æ–‡ç« å¼€ç¯‡æ¦‚è¿°

ç›¸å¯¹äºå…¶ä»–ç¼–ç¨‹è¯­è¨€æ¥è¯´ï¼ŒPython ç”Ÿæ€ä¸­æœ€çªå‡ºçš„å°±æ˜¯ç¬¬ä¸‰æ–¹åº“ã€‚ä»»ä½•ä¸€ä¸ªåŠæ ¼çš„ Python å¼€å‘è€…éƒ½ä½¿ç”¨è¿‡è‡³å°‘ 5 æ¬¾ç¬¬ä¸‰æ–¹åº“ã€‚

å°±çˆ¬è™«é¢†åŸŸè€Œè¨€ï¼Œå¿…å°†ç”¨åˆ°çš„ä¾‹å¦‚ç½‘ç»œè¯·æ±‚åº“ Requestsã€ç½‘é¡µè§£æåº“ Parsel æˆ– BeautifulSoupã€æ•°æ®åº“å¯¹è±¡å…³ç³»æ˜ å°„  Motor æˆ– SQLAlchemyã€å®šæ—¶ä»»åŠ¡ Apschedulerã€çˆ¬è™«æ¡†æ¶ Scrapy ç­‰ã€‚


![](https://user-gold-cdn.xitu.io/2019/9/14/16d2dd8be3d2254d?w=1376&h=910&f=png&s=1290872)

è¿™äº›å¼€æºåº“çš„ä½¿ç”¨æ–¹æ³•æƒ³å¿…å¤§å®¶å·²ç»éå¸¸ç†Ÿç»ƒäº†ï¼Œç”šè‡³è¿˜ä¿®ç‚¼å‡ºäº†è‡ªå·±çš„ä¸€å¥—æŠ€å·§ï¼Œæ—¥å¸¸å·¥ä½œä¸­æ•²èµ·é”®ç›˜è‚¯å®šä¹Ÿæ˜¯å“’å“’å“’çš„å“ã€‚

ä½†æ˜¯ä½ æœ‰æ²¡æœ‰æƒ³è¿‡ï¼š

- é‚£ä¸ªç¥å¥‡çš„åŠŸèƒ½æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ
- è¿™ä¸ªåŠŸèƒ½èƒŒåçš„é€»è¾‘æ˜¯ä»€ä¹ˆï¼Ÿ
- ä¸ºä»€ä¹ˆè¦è¿™æ ·åšè€Œä¸æ˜¯é€‰æ‹©å¦ä¸€ç§å†™æ³•ï¼Ÿ
- ç¼–å†™è¿™æ ·çš„åº“éœ€è¦ç”¨åˆ°å“ªäº›çŸ¥è¯†ï¼Ÿ
- è¿™ä¸ªè®ºç‚¹æ˜¯å¦æœ‰æ˜ç¡®çš„ä¾æ®ï¼Ÿ


![](https://user-gold-cdn.xitu.io/2019/9/14/16d2dda24b0853ed?w=312&h=312&f=png&s=127644)
å¦‚æœä½ ä»æœªè¿™æ ·æƒ³è¿‡ï¼Œé‚£è¯´æ˜ä½ è¿˜æ²¡åˆ°è¾¾åº”è¯¥ã€Œæ¸¡åŠ«ã€çš„æ—¶æœºï¼›å¦‚æœä½ æ›¾æå‡ºè¿‡ 3 ä¸ªä»¥ä¸Šçš„ç–‘é—®ï¼Œé‚£è¯´æ˜ä½ å³å°†åˆ°è¾¾é‚£ä¸ªé‡è¦çš„å…³å£ï¼›å¦‚æœä½ å¸¸å¸¸è¿™ä¹ˆæƒ³ï¼Œè€Œä¸”ä¹Ÿå°è¯•ç€å¯»æ‰¾å¯¹åº”çš„ç­”æ¡ˆï¼Œé‚£ä¹ˆæ­å–œä½ ï¼Œä½ ç°åœ¨æ­£å¤„äºã€Œæ¸¡åŠ«ã€çš„å…³å£ä¹‹ä¸Šã€‚


![](https://user-gold-cdn.xitu.io/2019/9/14/16d2de0cdaef77c5?w=538&h=282&f=png&s=104780)
å¶æœ‰ç¾¤å‹ä¼šæŠ›å‡ºè¿™æ ·çš„é—®é¢˜ï¼šåˆçº§å·¥ç¨‹å¸ˆã€ä¸­çº§å·¥ç¨‹å¸ˆã€é«˜çº§å·¥ç¨‹å¸ˆå¦‚ä½•ç•Œå®šï¼Ÿ

è¿™ä¸ªé—®é¢˜æœ‰ä¸¤ç§ä¸åŒçš„è§‚ç‚¹ï¼Œç¬¬ä¸€ä¸ªæ˜¯çœ‹å·¥ä½œèŒçº§ï¼Œç¬¬äºŒä¸ªåˆ™æ˜¯çœ‹ä¸ªäººèƒ½åŠ›ã€‚å·¥ä½œèŒçº§æ˜¯ä¸€ä¸ªæµ®åŠ¨å¾ˆå¤§çš„å‚ç…§ç‰©ï¼Œä¾‹å¦‚é˜¿é‡Œå·´å·´çš„é«˜çº§ç ”å‘å’Œæˆ‘å¸çš„é«˜çº§ç ”å‘ï¼ŒèŒçº§åç§°éƒ½æ˜¯ã€Œé«˜çº§ç ”å‘ã€ï¼Œä½†èƒ½åŠ›å¯èƒ½ä¼šæœ‰å¾ˆå¤§çš„å·®è·ã€‚

ä¸ªäººèƒ½åŠ›åˆå¦‚ä½•è¯„å®šå‘¢ï¼Ÿ

éš¾ä¸æˆçœ‹ä»£ç å†™çš„å¿«è¿˜æ˜¯å†™çš„æ…¢å—ï¼Ÿ

å½“ç„¶ä¸æ˜¯ï¼

ä¸ªäººèƒ½åŠ›åº”å½“ä»å¹¿åº¦å’Œæ·±åº¦ä¸¤ä¸ªæ–¹é¢è¿›è¡Œè€ƒé‡ï¼Œè¿™å¹¶æ²¡æœ‰ä¸€ä¸ªæ˜ç¡®çš„æ ‡å‡†ã€‚å½“ä¸¤äººèƒ½åŠ›å·®å¼‚å¾ˆå¤§çš„æ—¶å€™ï¼Œå¤–äººå¯ä»¥è½»æ¾çš„åˆ†è¾¨å­°å¼ºå­°å¼±ã€‚

è‡ªå·±æ€æ ·åˆ†è¾¨ä¸ªäººèƒ½åŠ›çš„è¿›ä¸é€€å‘¢ï¼Ÿ

è¿™å°±å›åˆ°äº†ä¸Šé¢æåˆ°çš„é‚£äº›é—®é¢˜ï¼šWHO WHAT WHERE WHY WHEN HOWï¼Ÿ

æˆ‘æƒ³é€šè¿‡è¿™ç¯‡æ–‡ç« å‘Šè¯‰ä½ ï¼Œä¸è¦åšé‚£ä¸ªç”¨åº“ç”¨å¾—å¾ˆç†Ÿç»ƒçš„äººï¼Œè¦åšé‚£ä¸ªåˆ›é€ åº“çš„äººã€‚è®¡ç®—æœºä¸–ç•Œå¦‚æ­¤å¸å¼•äººï¼Œå°±æ˜¯å› ä¸ºæˆ‘ä»¬å¯ä»¥åœ¨è¿™ä¸ªä¸–ç•Œé‡Œå°½æƒ…åˆ›é€ ã€‚

ä½ æƒ³åšä¸€ä¸ªåˆ›é€ è€…å—ï¼Ÿ

å¦‚æœä¸æƒ³ï¼Œé‚£ç°åœ¨ä½ å°±å¯ä»¥å…³æ‰æµè§ˆå™¨çª—å£ï¼Œå›åˆ° Hub çš„ä¸–ç•Œé‡Œã€‚



## å†…å®¹ä»‹ç»

è¿™æ˜¯ä¸€å¥—ç³»åˆ—æ–‡ç« ï¼Œè¿™ä¸ªç³»åˆ—å°†ä¸ºå¤§å®¶è§£è¯»å¸¸è§åº“ï¼ˆä¾‹å¦‚ WebSocketã€HTTPã€ASCIIã€Base64ã€MD5ã€AESã€RSAï¼‰çš„åè®®è§„èŒƒå’Œå¯¹åº”çš„ä»£ç å®ç°ï¼Œå¸®åŠ©å¤§å®¶ã€ŒçŸ¥å…¶ç„¶ï¼ŒçŸ¥å…¶æ‰€ä»¥ç„¶ã€ã€‚

### ç›®æ ‡

è¿™æ¬¡æˆ‘ä»¬è¦å­¦ä¹ çš„æ˜¯ WebSocket åè®®è§„èŒƒå’Œä»£ç å®ç°ï¼Œä¹Ÿå¯ä»¥ç†è§£ä¸ºä» 0 å¼€å§‹ç¼–å†™ [aiowebsocket](https://github.com/asyncins/aiowebsocket) åº“ã€‚è‡³äºä¸ºä»€ä¹ˆé€‰æ‹©å®ƒï¼Œé‚£å¤§æ¦‚æ˜¯å› ä¸ºå…¨ä¸–ç•Œæ²¡æœ‰æ¯”æˆ‘æ›´ç†Ÿæ‚‰çš„å®ƒçš„äººäº†ã€‚

![](https://user-gold-cdn.xitu.io/2019/9/14/16d2de2d6c55bdcd?w=900&h=383&f=png&s=222353)

æˆ‘æ˜¯ aiowebsocket åº“çš„ä½œè€…ï¼Œæˆ‘èŠ±äº† 7 å¤©ç¼–å†™è¿™ä¸ªåº“ã€‚å†™åº“çš„è¿‡ç¨‹ï¼Œè®©æˆ‘æ·±åˆ»ä½“ä¼šåˆ°é€ è½®å­å’Œé©¾é©¶çš„åŒºåˆ«ï¼Œä¹Ÿè®©æˆ‘æœ‰äº†é£é€Ÿçš„è¿›æ­¥ã€‚æˆ‘å¸Œæœ›ç”¨è¿è½½ç³»åˆ—æ–‡ç« çš„å½¢å¼å¸®åŠ©å¤§å®¶ä»é©¾é©¶è€…è½¬æ¢åˆ°åˆ›é€ è€…ï¼Œæ‹¥æœ‰ã€Œç¼–ç¨‹æ€è€ƒã€ã€‚

### å‰ç½®æ¡ä»¶

WebSocket æ˜¯ä¸€ç§åœ¨å•ä¸ª TCP è¿æ¥ä¸Šè¿›è¡Œå…¨åŒå·¥é€šä¿¡çš„åè®®ï¼Œå®ƒçš„å‡ºç°ä½¿å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„æ•°æ®äº¤æ¢å˜å¾—æ›´åŠ ç®€å•ã€‚ä¸‹å›¾æè¿°äº†åŒç«¯äº¤äº’çš„æµç¨‹:

![](https://user-gold-cdn.xitu.io/2019/9/14/16d2de4a2f5a3b5d?w=978&h=600&f=png&s=74626)

WebSocket é€šå¸¸è¢«åº”ç”¨åœ¨å®æ—¶æ€§è¦æ±‚è¾ƒé«˜çš„åœºæ™¯ï¼Œä¾‹å¦‚èµ›äº‹æ•°æ®ã€è‚¡ç¥¨è¯åˆ¸ã€ç½‘é¡µèŠå¤©å’Œåœ¨çº¿ç»˜å›¾ç­‰ã€‚WebSocket ä¸ HTTP åè®®å®Œå…¨ä¸åŒï¼Œä½†åŒæ ·è¢«å¹¿æ³›åº”ç”¨ã€‚

æ— è®ºæ˜¯åç«¯å¼€å‘è€…ã€å‰ç«¯å¼€å‘è€…ã€çˆ¬è™«å·¥ç¨‹å¸ˆæˆ–è€…ä¿¡æ¯å®‰å…¨å·¥ä½œè€…ï¼Œéƒ½åº”è¯¥æŒæ¡ WebSocket åè®®çš„çŸ¥è¯†ã€‚

æˆ‘æ›¾ç»å‘è¡¨è¿‡å‡ ç¯‡å…³äº WebSocket çš„æ–‡ç« ï¼š

- [ã€ä¸¥é€‰-é«˜è´¨é‡æ–‡ç« ã€‘å¼€å‘è€…å¿…çŸ¥å¿…ä¼šçš„ WebSocket åè®®](https://juejin.im/post/5d4cbc0cf265da038f47fa37)
- [Pythonå¦‚ä½•çˆ¬å–å®æ—¶å˜åŒ–çš„WebSocketæ•°æ®](https://juejin.im/post/5c80b768f265da2dae514d4f)
- [WebSocket ä»å…¥é—¨åˆ°å†™å‡ºå¼€æºåº“](https://juejin.im/post/5c7cdaabf265da2daf79c15f)

å…¶ä¸­ï¼Œã€Šã€ä¸¥é€‰-é«˜è´¨é‡æ–‡ç« ã€‘å¼€å‘è€…å¿…çŸ¥å¿…ä¼šçš„ WebSocket åè®®ã€‹ä»‹ç»äº†åè®®è§„èŒƒçš„ç›¸å…³çŸ¥è¯†ã€‚è¿™ç¯‡æ–‡ç« çš„å†…å®¹å¤§ä½“å¦‚ä¸‹ï¼š

- WebSocket åè®®æ¥æº
- WebSocket åè®®çš„ä¼˜ç‚¹
- WebSocket åè®®è§„èŒƒ
- ä¸€äº›å®é™…ä»£ç æ¼”ç¤º

å¦‚æœæ²¡æœ‰æŒæ¡ WebSocket åè®®çš„æœ‹å‹ï¼Œæˆ‘å»ºè®®å…ˆå»é˜…è¯»è¿™ç¯‡æ–‡ç« ï¼Œå°¤å…¶æ˜¯å¯¹ [WebSocket åè®®è§„èŒƒ](https://juejin.im/post/5d4cbc0cf265da038f47fa37#heading-4)ä»‹ç»çš„é‚£éƒ¨åˆ†ã€‚

è¦æƒ³å°†åè®®è§„èŒƒ RFC6455 å˜æˆå¼€æºåº“ï¼Œç¬¬ä¸€æ­¥å°±æ˜¯è¦ç†Ÿæ‚‰æ•´ä¸ªåè®®è§„èŒƒï¼Œæ‰€ä»¥ä½ éœ€è¦é˜…è¯»[ã€ä¸¥é€‰-é«˜è´¨é‡æ–‡ç« ã€‘å¼€å‘è€…å¿…çŸ¥å¿…ä¼šçš„ WebSocket åè®®](https://juejin.im/post/5d4cbc0cf265da038f47fa37)ã€‚å½“ç„¶ï¼Œæœ‰èƒ½åŠ›çš„åŒå­¦ç›´æ¥é˜…è¯» RFC6455 ä¹Ÿæœªå°ä¸å¯ã€‚

æ¥ç€è¿˜éœ€è¦äº†è§£ç¼–ç¨‹è¯­è¨€ä¸­å†…ç½®åº“ Socket çš„åŸºç¡€ç”¨æ³•ï¼Œä¾‹å¦‚ Python ä¸­çš„ [socket](https://docs.python.org/3/library/socket.html?highlight=socket#module-socket) æˆ–è€…æ›´é«˜çº§æ›´æ½®çš„ [Streams](https://docs.python.org/3/library/asyncio-stream.html)ã€[Transports and Protocols](https://docs.python.org/3/library/asyncio-protocol.html)ã€‚å¦‚æœä½ æ˜¯ Go å¼€å‘è€…ã€Rust å¼€å‘è€…ï¼Œè¯·æŸ¥æ‰¾å¯¹åº”è¯­è¨€çš„å†…ç½®åº“ã€‚

å‡è®¾ä½ å·²ç»ç†Ÿæ‚‰äº† RFC6455ï¼Œä½ åº”è¯¥çŸ¥é“ Frame æ‰“åŒ…å’Œè§£åŒ…çš„æ—¶å€™éœ€è¦ç”¨åˆ°ä½è¿ç®—ï¼Œæ­£å¥½æˆ‘ä¹‹å‰å†™è¿‡ä½è¿ç®—ç›¸å…³çš„æ–‡ç«  [7åˆ†é’Ÿå…¨é¢äº†è§£ä½è¿ç®—](https://gitbook.cn/gitchat/activity/5d4d6d8f6f29256fa317e946)ã€‚

è‡³äºå…¶å®ƒçš„ï¼Œç°ç”¨ç°å­¦å§ï¼

## Python ç½‘ç»œé€šä¿¡ä¹‹ Streams

WebSocketï¼Œä¹Ÿå¯ä»¥ç†è§£ä¸ºåœ¨ WEB åº”ç”¨ä¸­ä½¿ç”¨çš„ Socketï¼Œè¿™æ„å‘³ç€æœ¬ç¯‡å°†ä¼šæ¶‰åŠåˆ° Socket ç¼–ç¨‹ã€‚ä¸Šé¢æåˆ°ï¼ŒPython ä¸­ä¸ Socket ç›¸å…³çš„æœ‰ socketã€Streamsã€Transports and Protocolsã€‚å…¶ä¸­ socket æ˜¯åŒæ­¥çš„ï¼Œè€Œå¦å¤–ä¸¤ä¸ªæ˜¯å¼‚æ­¥çš„ï¼Œè¿™ä¿©å±äºä½ å¸¸å¬åˆ°çš„ asyncioã€‚

### Socket é€šä¿¡è¿‡ç¨‹

Socket æ˜¯ç«¯åˆ°ç«¯çš„é€šä¿¡ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦ææ¸…æ¥šæ¶ˆæ¯æ˜¯æ€ä¹ˆä»ä¸€å°æœºå™¨å‘é€åˆ°å¦ä¸€å°æœºå™¨çš„ï¼Œè¿™å¾ˆé‡è¦ã€‚å‡è®¾é€šä¿¡çš„ä¸¤å°æœºå™¨ä¸º Client å’Œ Serverï¼ŒClient å‘ Server å‘é€æ¶ˆæ¯çš„è¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](https://user-gold-cdn.xitu.io/2019/9/14/16d2b6eccf4d7221?w=1240&h=672&f=jpeg&s=44507)

> Client é€šè¿‡æ–‡ä»¶æè¿°ç¬¦çš„è¯»å†™ API  read & write æ¥è®¿é—®æ“ä½œç³»ç»Ÿå†…æ ¸ä¸­çš„ç½‘ç»œæ¨¡å—ä¸ºå½“å‰å¥—æ¥å­—åˆ†é…çš„å‘é€  send buffer å’Œæ¥æ”¶ recv buffer ç¼“å­˜ã€‚
>
> Client è¿›ç¨‹å†™æ¶ˆæ¯åˆ°å†…æ ¸çš„å‘é€ç¼“å­˜ä¸­ï¼Œå†…æ ¸å°†å‘é€ç¼“å­˜ä¸­çš„æ•°æ®ä¼ é€åˆ°ç‰©ç†ç¡¬ä»¶ NICï¼Œä¹Ÿå°±æ˜¯ç½‘ç»œæ¥å£èŠ¯ç‰‡ (Network Interface Circuit)ã€‚
>
> NIC è´Ÿè´£å°†ç¿»è¯‘å‡ºæ¥çš„æ¨¡æ‹Ÿä¿¡å·é€šè¿‡ç½‘ç»œç¡¬ä»¶ä¼ é€’åˆ°æœåŠ¡å™¨ç¡¬ä»¶çš„ NICã€‚
>
> æœåŠ¡å™¨çš„ NIC å†å°†æ¨¡æ‹Ÿä¿¡å·è½¬æˆå­—èŠ‚æ•°æ®å­˜æ”¾åˆ°å†…æ ¸ä¸ºå¥—æ¥å­—åˆ†é…çš„æ¥æ”¶ç¼“å­˜ä¸­ï¼Œæœ€ç»ˆæœåŠ¡å™¨è¿›ç¨‹ä»æ¥æ”¶ç¼“å­˜ä¸­è¯»å–æ•°æ®å³ä¸ºæºå®¢æˆ·ç«¯è¿›ç¨‹ä¼ é€’è¿‡æ¥çš„ æ¶ˆæ¯ã€‚

ä¸Šè¿°é€šä¿¡è¿‡ç¨‹çš„æè¿°å’Œå›¾ç‰‡å‡å‡ºè‡ªé’±æ–‡å“çš„æ·±å…¥ç†è§£ RPC äº¤äº’æµç¨‹ã€‚

æˆ‘å°è¯•å¯»æ‰¾é€šä¿¡è¿‡ç¨‹ä¸­æ¯ä¸ªæ­¥éª¤çš„ä¾æ®ï¼ˆå°¤å…¶æ˜¯ send buffer to NIC to recv bufferï¼‰ï¼Œï¼ˆæˆ‘ç¿»é˜…äº† TCP çš„ RFC å’Œ Kernel.orgï¼‰ä½†é—æ†¾çš„æ˜¯å¹¶æœªæ‰¾åˆ°æœ‰åŠ›çš„è¯æ˜ï¼ˆä¸€å®šæ˜¯æˆ‘å¤ªèœäº†ï¼‰ï¼Œå¦‚æœæœ‰æœ‹å‹çŸ¥é“ï¼Œå¯ä»¥è¯„è®ºå‘Šè¯‰æˆ‘æˆ–å‘é‚®ä»¶ zenrusts@sina.com å‘Šè¯‰æˆ‘ï¼Œæˆ‘å¯ä»¥æ‰©å±•å‡ºå¦ä¸€ç¯‡æ–‡ç« ã€‚

### åˆ›å»º Streams

é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼šåœ¨ Python ä¸­ï¼Œæˆ‘ä»¬å¦‚ä½•å®ç°ç«¯åˆ°ç«¯çš„æ¶ˆæ¯å‘é€å‘¢ï¼Ÿ

ç­”ï¼šPython æä¾›äº†ä¸€äº›å¯¹è±¡å¸®åŠ©æˆ‘ä»¬å®ç°è¿™ä¸ªéœ€æ±‚ï¼Œå…¶ä¸­ç›¸å¯¹ç®€å•æ˜“ç”¨çš„æ˜¯ Streamsã€‚

Streams æ˜¯ Python Asynchronous I/O ä¸­æä¾›çš„ High-level APIsã€‚Python å®˜æ–¹æ–‡æ¡£å¯¹ Streams çš„ä»‹ç»å¦‚ä¸‹ï¼š

> Streams are high-level async/await-ready primitives to work with network connections. Streams allow sending and receiving data without using callbacks or low-level protocols and transports.

æˆ‘å°¬è¯‘ä¸€ä¸‹ï¼šStreams æ˜¯ç”¨äºç½‘ç»œè¿æ¥çš„ high-level async/await-ready åŸè¯­ã€‚Streams å…è®¸åœ¨ä¸ä½¿ç”¨å›è°ƒæˆ– low-level protocols and transports çš„æƒ…å†µä¸‹å‘é€å’Œæ¥æ”¶æ•°æ®ã€‚

Python æä¾›äº† `asyncio.open_connection()` è®©å¼€å‘è€…åˆ›å»º Streamsï¼Œ`asyncio.open_connection()` å°†å»ºç«‹ç½‘ç»œè¿æ¥å¹¶è¿”å› reader å’Œ writer å¯¹è±¡ï¼Œè¿™ä¸¤ä¸ªå¯¹è±¡å…¶å®æ˜¯ StreamReader å’Œ StreamWriter ç±»çš„å®ä¾‹ã€‚

å¼€å‘è€…å¯ä»¥é€šè¿‡ StreamReader ä» IO æµä¸­è¯»å–æ•°æ®ï¼Œé€šè¿‡ StreamWriter å°†æ•°æ®å†™å…¥ IO æµã€‚è™½ç„¶æ–‡æ¡£å¹¶æ²¡æœ‰ç»™å‡º IO æµçš„æ˜ç¡®å®šä¹‰ï¼Œä½†æˆ‘çŒœå®ƒè·Ÿ buffer ï¼ˆä¹Ÿå°±æ˜¯ send buffer to NIC to recv buffer ä¸­çš„ bufferï¼‰æœ‰å…³ï¼Œä½ ä¹Ÿå¯ä»¥æŠ½è±¡çš„è®¤ä¸ºå®ƒå°±æ˜¯ bufferã€‚

æœ‰äº† Streamsï¼Œå°±æœ‰äº†ç«¯åˆ°ç«¯æ¶ˆæ¯å‘é€çš„å®Œæ•´å®ç°ã€‚ä¸‹é¢å°†é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥ç†Ÿæ‚‰ Streams çš„ç”¨æ³•å’Œç”¨é€”ã€‚è¿™æ˜¯ Python å®˜æ–¹æ–‡æ¡£ç»™å‡ºçš„åŒç«¯ç¤ºä¾‹ï¼Œé¦–å…ˆæ˜¯ Server ç«¯ï¼š

```
# TCP echo server using streams
# æœ¬æ–‡å‡ºè‡ªã€Œå¤œå¹•å›¢é˜Ÿ NightTeamã€ è½¬è½½è¯·è”ç³»å¹¶å–å¾—æˆæƒ
import asyncio

async def handle_echo(reader, writer):
    data = await reader.read(100)
    message = data.decode()
    addr = writer.get_extra_info('peername')

    print(f"Received {message!r} from {addr!r}")

    print(f"Send: {message!r}")
    writer.write(data)
    await writer.drain()

    print("Close the connection")
    writer.close()

async def main():
    server = await asyncio.start_server(
        handle_echo, '127.0.0.1', 8888)

    addr = server.sockets[0].getsockname()
    print(f'Serving on {addr}')

    async with server:
        await server.serve_forever()

asyncio.run(main())
```

æ¥ç€æ˜¯ Client ç«¯ï¼š

```
# TCP echo client using streams
# æœ¬æ–‡å‡ºè‡ªã€Œå¤œå¹•å›¢é˜Ÿ NightTeamã€ è½¬è½½è¯·è”ç³»å¹¶å–å¾—æˆæƒ
import asyncio

async def tcp_echo_client(message):
    reader, writer = await asyncio.open_connection(
        '127.0.0.1', 8888)

    print(f'Send: {message!r}')
    writer.write(message.encode())

    data = await reader.read(100)
    print(f'Received: {data.decode()!r}')

    print('Close the connection')
    writer.close()

asyncio.run(tcp_echo_client('Hello World!'))
```

å°†ç¤ºä¾‹åˆ†åˆ«å†™å…¥åˆ° server.py å’Œ client.py ä¸­ï¼Œç„¶åæŒ‰åºè¿è¡Œã€‚æ­¤æ—¶ server.py çš„çª—å£ä¼šè¾“å‡ºå¦‚ä¸‹å†…å®¹ï¼š

```
Serving on ('127.0.0.1', 8888)
Received 'Hello World!' from ('127.0.0.1', 59534)
Send: 'Hello World!'
Close the connection
```

ä»è¾“å‡ºä¸­å¾—çŸ¥ï¼ŒæœåŠ¡å¯åŠ¨çš„ address å’Œ port ä¸º `('127.0.0.1', 8888)`ï¼Œä» `('127.0.0.1', 59534)` è¯»å–åˆ°å†…å®¹ä¸º `Hello World!` çš„æ¶ˆæ¯ï¼Œæ¥ç€å°† `Hello World!` è¿”å›ç»™  `('127.0.0.1', 59534)` ï¼Œæœ€åå…³é—­è¿æ¥ã€‚

client.py çš„çª—å£è¾“å‡ºå†…å®¹å¦‚ä¸‹ï¼š

```
Send: 'Hello World!'
Received: 'Hello World!'
Close the connection
```

åœ¨åˆ›å»ºè¿æ¥åï¼ŒClient å‘æŒ‡å®šçš„ç«¯å‘é€äº†å†…å®¹ä¸º `Hello World!`  çš„æ¶ˆæ¯ï¼Œæ¥ç€ä»æŒ‡å®šçš„ç«¯æ¥æ”¶åˆ°å†…å®¹ä¸º  `Hello World!`  çš„æ¶ˆæ¯ï¼Œæœ€åå…³é—­è¿æ¥ã€‚

æœ‰äº›è¯»è€…å¯èƒ½ä¸å¤ªç†è§£ï¼Œä¸ºä»€ä¹ˆ Client Send  `Hello World!` ï¼Œè€Œ Server æ¥æ”¶åˆ°ä¹‹åä¹Ÿå‘ Client Send  `Hello World!` ã€‚åŒç«¯çš„ Send å’Œ Received éƒ½æ˜¯  `Hello World!` ï¼Œè¿™å¾ˆå®¹æ˜“è®©æ–°æ‰‹æ‡µé€¼ã€‚å®é™…ä¸Šè¿™å°±æ˜¯ä¸€ä¸ªæ™®é€šçš„å›æ˜¾æœåŠ¡å™¨ç¤ºä¾‹ï¼Œä¹Ÿå°±æ˜¯è¯´å½“ Server æ”¶åˆ°æ¶ˆæ¯æ—¶ï¼Œå°†æ¶ˆæ¯å†…å®¹åŸå°ä¸åŠ¨çš„è¿”å›ç»™ Clientã€‚

è¿™æ ·åªæ˜¯ä¸ºäº†æ¼”ç¤ºï¼Œå¹¶æ— å®ƒæ„ï¼Œä½†è¿™æ ·çš„ç¤ºä¾‹å´ä¼šç»™æ–°æ‰‹å¸¦æ¥å›°æ‰°ã€‚

ä»¥ä¸Šæ˜¯ä¸€ä¸ªç®€å•çš„ Socket ç¼–ç¨‹ç¤ºä¾‹ï¼Œæ•´ä½“æ€è·¯ç†è§£èµ·æ¥è¿˜æ˜¯å¾ˆè½»æ¾çš„ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°†é€æ­¥è§£è¯»ç¤ºä¾‹ä¸­çš„ä»£ç ï¼š

    * client.py ä¸­ç”¨ `asyncio.open_connection()` è¿æ¥æŒ‡å®šçš„ç«¯ï¼Œå¹¶è·å¾— reader å’Œ writer è¿™ä¸¤ä¸ªå¯¹è±¡ã€‚
    * ç„¶åä½¿ç”¨ writer å¯¹è±¡ä¸­çš„ `write()` æ–¹æ³•å°† `Hello World!` å†™å…¥åˆ° IO æµä¸­ï¼Œè¯¥æ¶ˆæ¯ä¼šè¢«å‘é€åˆ° Serverã€‚
    * æ¥ç€ä½¿ç”¨ reader å¯¹è±¡ä¸­çš„ `read()` æ–¹æ³•ä» IO æµä¸­è¯»å–æ¶ˆæ¯ï¼Œå¹¶å°†æ¶ˆæ¯æ‰“å°åˆ°ç»ˆç«¯ã€‚

çœ‹åˆ°è¿™é‡Œï¼Œä½ æˆ–è®¸ä¼šæœ‰å¦ä¸€ä¸ªç–‘é—®ï¼š`write()` åªæ˜¯å°†æ¶ˆæ¯å†™å…¥åˆ° IO æµï¼Œå¹¶æ²¡æœ‰å‘é€è¡Œä¸ºï¼Œé‚£æ¶ˆæ¯æ˜¯å¦‚ä½•ä¼ è¾“åˆ° Server çš„å‘¢ï¼Ÿ

ç”±äºæ— æ³•ç›´æ¥è·Ÿè¿› CPython æºä»£ç ï¼Œæ‰€ä»¥æˆ‘ä»¬æ— æ³•å¾—åˆ°ç¡®åˆ‡çš„ç»“æœã€‚ä½†æˆ‘ä»¬å¯ä»¥è·Ÿè¿› Python ä»£ç ï¼Œå¾—çŸ¥æ¶ˆæ¯æœ€åä¼ è¾“åˆ° `transport.write()` ï¼Œå¦‚æœä½ æƒ³çŸ¥é“æ›´å¤šï¼Œå¯ä»¥å»çœ‹ Transports and Protocols çš„ä»‹ç»ã€‚ä½ å¯ä»¥å°†è¿™ä¸ªè¿‡ç¨‹æŠ½è±¡ä¸ºä¸Šå›¾çš„ Client to  send buffer to NIC to recv buffer to Serverã€‚

## åŠŸèƒ½æ¨¡å—è®¾è®¡

é€šè¿‡ä¸Šé¢çš„å­¦ä¹ ï¼Œç°åœ¨ä½ å·²ç»æŒæ¡äº† WebSocket åè®®è§„èŒƒå’Œ Python Streams çš„åŸºæœ¬ç”¨æ³•ï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥è®¾è®¡ä¸€ä¸ª WebSocket å®¢æˆ·ç«¯åº“äº†ã€‚

æ ¹æ® RFC6455 çš„çº¦å®šï¼ŒWebSocket ä¹‹å‰æ˜¯ HTTPï¼Œé€šè¿‡ã€Œæ¡æ‰‹ã€æ¥å‡çº§åè®®ã€‚åè®®å‡çº§åè¿›å…¥çœŸæ­£çš„ WebSocket é€šä¿¡ï¼Œé€šä¿¡åŒ…å«å‘é€ï¼ˆSendï¼‰å’Œæ¥æ”¶ï¼ˆRecvï¼‰ã€‚æ–‡æœ¬æ¶ˆæ¯è¦åœ¨ä¼ è¾“è¿‡ç¨‹å‰è½¬æ¢ä¸º Framesï¼Œè€Œæ¥å—ç«¯è¯»å–åˆ°æ¶ˆæ¯åè¦å°† Frames è½¬æ¢æˆæ–‡æœ¬ã€‚å½“ç„¶ï¼ŒæœŸé—´ä¼šæœ‰ä¸€äº›å¼‚å¸¸äº§ç”Ÿï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦è‡ªå®šä¹‰å¼‚å¸¸ï¼Œä»¥å¿«é€Ÿå®šä½é—®é¢˜æ‰€åœ¨ã€‚ç°åœ¨æˆ‘ä»¬å¾—å‡ºäº†å‡ ä¸ªæ¨¡å—ï¼š

    * æ¡æ‰‹ - ShakeHands
    
    * ä¼ è¾“ - Transports
    
    * å¸§å¤„ç† - Frames
    
    * å¼‚å¸¸ - Exceptions

ä¸€åˆ‡å‡†å¤‡å°±ç»ªåï¼Œå°±å¯ä»¥è¿›å…¥çœŸæ­£çš„ç¼–ç ç¯èŠ‚äº†ã€‚

ç”±äºå®æˆ˜ç¼–ç ç¯‡å¹…å¤ªé•¿ï¼Œæˆ‘å†³å®šæ”¾åˆ°ä¸‹ä¸€æœŸï¼Œè¿™æœŸçš„å†…å®¹ï¼Œè¯»è€…ä»¬å¯èƒ½éœ€è¦èŠ±è´¹ä¸€äº›æ—¶é—´å¸æ”¶ã€‚


## å°ç»“

å¼€ç¯‡æˆ‘å¼ºè°ƒäº†ã€Œåˆ›é€ èƒ½åŠ›ã€æœ‰å¤šä¹ˆé‡è¦ï¼Œç”šè‡³æŠ›å‡ºäº†ä¸€äº›ä¸æ˜¯å¾ˆè´´åˆ‡çš„ä¾‹å­ï¼Œä½†æˆ‘å°±æ˜¯æƒ³å‘Šè¯‰ä½ ï¼Œä¸è¦åšè°ƒå‚ğŸ¶ã€‚

ç„¶åæˆ‘å‘Šè¯‰ä½ ï¼Œæœ¬ç¯‡æ–‡ç« è¦è®²è§£çš„æ˜¯ WebSocketã€‚

æ¥ç€åˆè·Ÿä½ è¯´ï¼Œè¦æŒæ¡ WebSocket åè®®ï¼Œå¦‚æœä½ æ— æ³•ç‹¬ç«‹å•ƒå®Œ RFC6455ï¼Œè¿˜å¯ä»¥çœ‹æˆ‘å†™è¿‡çš„å‡ ç¯‡å…³äº WebSocket æ–‡ç« å’Œä½è¿ç®—æ–‡ç« ã€‚

è¿‡äº†å‡ åˆ†é’Ÿï¼Œç»™ä½ å±•ç¤ºäº† Socket çš„é€šä¿¡è¿‡ç¨‹ï¼Œè™½ç„¶æ²¡æœ‰å¼ºæœ‰åŠ›çš„ä¾æ®ï¼Œä½†ä½ å¯ä»¥å‡è®¾è¿™æ˜¯å¯¹çš„ã€‚

å–äº†ä¸€æ¯ç™½å¼€æ°´ä¹‹åï¼Œæˆ‘å‘ä½ å±•ç¤ºäº† Streams çš„å…·ä½“ç”¨æ³•å¹¶ä¸ºä½ è§£è¯»ä»£ç çš„ä½œç”¨ï¼Œé‡è¦çš„æ˜¯å°† Streams ä¸ Socket é€šä¿¡è¿‡ç¨‹è¿›è¡Œäº†æŠ½è±¡ã€‚

è¿™äº›å‰ç½®æ¡ä»¶éƒ½ç¡®å®šåï¼Œæˆ‘åˆå¸¦ç€ä½ è‰è‰åœ°è®¾è®¡äº† WebSocket å®¢æˆ·ç«¯çš„åŠŸèƒ½æ¨¡å—ã€‚

ä¸‹ä¸€ç¯‡æ–‡ç« å°†è¿›å…¥ä»£ç å®æˆ˜ç¯èŠ‚ï¼Œè¯·åšå¥½ç¯å¢ƒï¼ˆPython 3.6+ï¼‰å‡†å¤‡ã€‚

æ€»ä¹‹ï¼Œè¦æƒ³è¶Šè¿‡å‰é¢è¿™åº§å±±ï¼Œå°±è¯·è·Ÿæˆ‘æ¥ï¼
